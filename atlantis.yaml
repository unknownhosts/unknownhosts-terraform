version: 3
automerge: true
projects:
  # Dev
  - name: dev/ap-southeast-1/test
    dir: ap-southeast-1/test
    workspace: dev
    workflow: terragrunt
    autoplan:
      enabled: false

  - name: dev/ap-southeast-1/eks/cluster
    dir: ap-southeast-1/eks/cluster
    workspace: dev
    workflow: terragrunt
    autoplan:
      enabled: false

# test
  - name: dev/ap-southeast-1/eks/nodegroup/launch_template
    dir: ap-southeast-1/eks/nodegroup/launch_template
    workspace: dev
    workflow: terragrunt
    autoplan:
      enabled: false

  - name: dev/ap-southeast-1/vpc
    dir: ap-southeast-1/vpc
    workspace: dev
    workflow: terragrunt
    autoplan:
      enabled: false

  - name: dev/ap-southeast-1/ec2/atlantis
    dir: ap-southeast-1/ec2/atlantis
    workspace: dev
    workflow: terragrunt
    autoplan:
      enabled: false

  - name: dev/eks_iam_roles
    dir: common/eks_iam_roles
    workspace: dev
    workflow: terragrunt
    autoplan:
      enabled: false

  # Prod
  - name: prod/ap-southeast-1/test
    dir: ap-southeast-1/test
    workspace: prod # default
    workflow: terragrunt
    autoplan:
      enabled: false

workflows:
  terragrunt:
    plan:
      steps:
        - env:
            name: TFVARS_FILE
            command: cat env/$WORKSPACE.tfvars
        - run: echo -e "env/$WORKSPACE.tfvars File \n$TFVARS_FILE \n\n\n"
        - run: terragrunt init -upgrade=true -no-color
        - run: terraform workspace select $WORKSPACE -no-color || terraform workspace new $WORKSPACE -no-color
        - run: terragrunt plan --var-file="env/$WORKSPACE.tfvars" -no-color -out $PLANFILE

    apply:
      steps:
        - run: terragrunt apply -no-color $PLANFILE